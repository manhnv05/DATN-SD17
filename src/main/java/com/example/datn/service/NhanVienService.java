package com.example.datn.service;

import com.example.datn.config.CloudinaryService;
import com.example.datn.dto.NhanVienDTO;
import com.example.datn.entity.NhanVien;
import com.example.datn.entity.VaiTro;
import com.example.datn.repository.NhanVienRepository;
import com.example.datn.repository.VaiTroRepository;
import com.example.datn.vo.nhanVienVO.NhanVienQueryVO;
import com.example.datn.vo.nhanVienVO.NhanVienUpdateVO;
import com.example.datn.vo.nhanVienVO.NhanVienVO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDate;
import java.sql.Date;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.stream.Collectors;

@Service
public class NhanVienService {
    private static final Logger log = LoggerFactory.getLogger(NhanVienService.class);

    @Autowired
    private VaiTroRepository vaiTroRepository;

    private final NhanVienRepository nhanVienRepository;

    @Autowired
    @Qualifier("emailConfigService")
    private com.example.datn.config.EmailService emailConfigService;

    @Autowired
    private CloudinaryService cloudinaryService;

    @Autowired
    public NhanVienService(NhanVienRepository nhanVienRepository) {
        this.nhanVienRepository = nhanVienRepository;
    }

    @Transactional
    public Integer save(NhanVienVO vO, MultipartFile imageFile) {
        NhanVien bean = new NhanVien();
        BeanUtils.copyProperties(vO, bean);

        // L∆∞u ·∫£nh l√™n Cloudinary n·∫øu c√≥ file upload
        if (imageFile != null && !imageFile.isEmpty()) {
            try {
                String imageUrl = cloudinaryService.uploadImage(imageFile);
                bean.setHinhAnh(imageUrl);
            } catch (Exception e) {
                // S·ª≠ d·ª•ng logger
                log.error("Kh√¥ng th·ªÉ upload ·∫£nh nh√¢n vi√™n l√™n Cloudinary: {}", e.getMessage(), e);
                throw new RuntimeException("Kh√¥ng th·ªÉ upload ·∫£nh l√™n Cloudinary: " + e.getMessage());
            }
        }

        // THAY ƒê·ªîI 2: C·∫£i thi·ªán x·ª≠ l√Ω l·ªói khi kh√¥ng t√¨m th·∫•y VaiTro
        if (vO.getIdVaiTro() != null) {
            VaiTro vaiTro = vaiTroRepository.findById(vO.getIdVaiTro())
                    .orElseThrow(() -> new NoSuchElementException("Kh√¥ng t√¨m th·∫•y VaiTro v·ªõi ID: " + vO.getIdVaiTro()));
            bean.setVaiTro(vaiTro);
        } else {
            bean.setVaiTro(null);
        }

        bean = nhanVienRepository.save(bean);

        // ---- PH·∫¶N G·ª¨I EMAIL GI·ªÆ NGUY√äN LOGIC NH∆ØNG C·∫¢I THI·ªÜN LOGGING ----
        if (emailConfigService != null && bean.getEmail() != null && !bean.getEmail().trim().isEmpty()) {
            String subject = "üéâ T√†i kho·∫£n nh√¢n vi√™n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng! üéâ";
            // N·ªôi dung email ƒë∆∞·ª£c t·∫°o tr·ª±c ti·∫øp t·∫°i ƒë√¢y theo y√™u c·∫ßu
            String body = "<div style=\"font-family:'Segoe UI',Arial,sans-serif;background:#f9fafd;padding:32px 0;\">"
                    + "<div style=\"max-width:520px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 4px 24px #e3e3ec;padding:40px 32px 32px 32px;\">"
                    + "<div style=\"text-align:center;\">"
                    + "    <img src=\"https://i.imgur.com/3fJ1P48.png\" alt=\"Logo Shop\" style=\"width:80px;margin-bottom:16px;\">"
                    + "    <h2 style=\"color:#1976d2;margin-bottom:8px;letter-spacing:1px;\">Ch√†o m·ª´ng b·∫°n gia nh·∫≠p Fashion Shirt Shop!</h2>"
                    + "    <p style=\"color:#444;font-size:17px;margin:0 0 20px 0;\">Xin ch√†o <b style='color:#1976d2'>" + bean.getHoVaTen() + "</b>,</p>"
                    + "</div>"
                    + "<div style=\"background:#f7fbfd;border-radius:12px;padding:24px 18px;margin:18px 0 22px 0;border:1.5px solid #e3f3fc;\">"
                    + "    <div style=\"font-size:17px;\">"
                    + "        <span style=\"color:#1976d2;font-weight:600;\">Th√¥ng tin ƒëƒÉng nh·∫≠p c·ªßa b·∫°n:</span><br>"
                    + "        <table style=\"width:100%;margin-top:12px;font-size:16px;\">"
                    + "            <tr><td style=\"padding:6px 0;color:#888;\">T√™n ƒëƒÉng nh·∫≠p:</td><td style=\"font-weight:700;color:#1976d2;\">" + bean.getEmail() + "</td></tr>"
                    + "            <tr><td style=\"padding:6px 0;color:#888;\">M·∫≠t kh·∫©u:</td><td style=\"font-weight:700;color:#1976d2;\">" + bean.getMatKhau() + "</td></tr>"
                    + "        </table>"
                    + "        <div style=\"margin-top:20px;color:#444;\">"
                    + "            Vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u sau khi ƒëƒÉng nh·∫≠p l·∫ßn ƒë·∫ßu ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n.<br>"
                    + "            <a href=\"http://localhost:3000/dang-nhap\" style=\"display:inline-block;margin-top:16px;padding:10px 32px;background:#1976d2;color:#fff;text-decoration:none;border-radius:8px;font-weight:600;box-shadow:0 2px 8px rgba(25,118,210,0.10);\">ƒêƒÉng nh·∫≠p ngay</a>"
                    + "        </div>"
                    + "    </div>"
                    + "</div>"
                    + "<div style=\"font-size:15px;color:#888;text-align:center;margin-top:12px;\">"
                    + "    N·∫øu b·∫°n kh√¥ng th·ª±c hi·ªán ƒëƒÉng k√Ω n√†y, h√£y b·ªè qua email n√†y.<br>"
                    + "    <i>ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi l·∫°i.</i>"
                    + "</div>"
                    + "</div>"
                    + "</div>";
            try {
                emailConfigService.sendEmail(
                        bean.getEmail(),
                        subject,
                        body
                );
                // Ghi log khi g·ª≠i th√†nh c√¥ng
                log.info("ƒê√£ g·ª≠i email t·∫°o t√†i kho·∫£n t·ªõi nh√¢n vi√™n: {}", bean.getEmail());
            } catch (Exception ex) {
                // THAY ƒê·ªîI 3: D√πng logger thay v√¨ System.err.println
                log.error("G·ª≠i email cho nh√¢n vi√™n {} th·∫•t b·∫°i. L·ªói: {}", bean.getEmail(), ex.getMessage(), ex);
            }
        }

        return bean.getId();
    }

    @Transactional
    public void delete(Integer id) {
        NhanVien bean = requireOne(id);
        nhanVienRepository.delete(bean);
    }

    @Transactional
    public void update(Integer id, NhanVienUpdateVO vO, MultipartFile imageFile) {
        NhanVien bean = requireOne(id);

        BeanUtils.copyProperties(vO, bean);

        if (imageFile != null && !imageFile.isEmpty()) {
            try {
                String imageUrl = cloudinaryService.uploadImage(imageFile);
                bean.setHinhAnh(imageUrl);
            } catch (Exception e) {
                throw new RuntimeException("Kh√¥ng th·ªÉ upload ·∫£nh l√™n Cloudinary: " + e.getMessage());
            }
        }

        if (vO.getIdVaiTro() != null) {
            VaiTro vaiTro = vaiTroRepository.findById(vO.getIdVaiTro()).orElse(null);
            bean.setVaiTro(vaiTro);
        } else {
            bean.setVaiTro(null);
        }

        nhanVienRepository.save(bean);
    }

    public NhanVienDTO getById(Integer id) {
        NhanVien original = requireOne(id);
        return toDTO(original);
    }

    public Page<NhanVienDTO> query(NhanVienQueryVO vO) {
        int page = vO.getPage() != null ? vO.getPage() : 0;
        int size = vO.getSize() != null ? vO.getSize() : 5;
        PageRequest pageRequest = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "id"));

        Specification<NhanVien> spec = Specification.where(null);

        if (vO.getHoVaTen() != null && !vO.getHoVaTen().trim().isEmpty()) {
            spec = spec.and((root, query, cb) ->
                    cb.like(cb.lower(root.get("hoVaTen")), "%" + vO.getHoVaTen().toLowerCase() + "%")
            );
        }
        if (vO.getGioiTinh() != null && !vO.getGioiTinh().trim().isEmpty()) {
            spec = spec.and((root, query, cb) ->
                    cb.equal(cb.lower(root.get("gioiTinh")), vO.getGioiTinh().toLowerCase())
            );
        }
        if (vO.getTrangThai() != null) {
            spec = spec.and((root, query, cb) ->
                    cb.equal(root.get("trangThai"), vO.getTrangThai())
            );
        }
        if (vO.getIdVaiTro() != null) {
            spec = spec.and((root, query, cb) ->
                    cb.equal(root.get("vaiTro").get("id"), vO.getIdVaiTro())
            );
        }

        Page<NhanVien> pageResult = nhanVienRepository.findAll(spec, pageRequest);

        List<NhanVienDTO> dtos = pageResult.getContent().stream()
                .map(this::toDTO)
                .collect(Collectors.toList());
        return new PageImpl<>(dtos, pageRequest, pageResult.getTotalElements());
    }

    private NhanVienDTO toDTO(NhanVien original) {
        NhanVienDTO bean = new NhanVienDTO();
        BeanUtils.copyProperties(original, bean);
        if (original.getVaiTro() != null) {
            bean.setIdVaiTro(original.getVaiTro().getId());
            bean.setTenVaiTro(original.getVaiTro().getTen());
        } else {
            bean.setIdVaiTro(null);
            bean.setTenVaiTro(null);
        }
        return bean;
    }

    private NhanVien requireOne(Integer id) {
        return nhanVienRepository.findById(id)
                .orElseThrow(() -> new NoSuchElementException("Resource not found: " + id));
    }
}